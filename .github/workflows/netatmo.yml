name: Fetch Netatmo Weather Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Fetch weather data
        env:
          NETATMO_CLIENT_ID: ${{ secrets.NETATMO_CLIENT_ID }}
          NETATMO_CLIENT_SECRET: ${{ secrets.NETATMO_CLIENT_SECRET }}
          NETATMO_REFRESH_TOKEN: ${{ secrets.NETATMO_REFRESH_TOKEN }}
        run: python BackEnds/the-snake-tank/fetch_weather.py

      - name: Update refresh token secret
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: gh secret set NETATMO_REFRESH_TOKEN --body "$(cat new_refresh_token.txt)"

      - name: Install ML dependencies
        run: pip install pandas scikit-learn joblib

      - name: Rebuild dataset
        run: python BackEnds/the-snake-tank/build_dataset.py

      - name: Train prediction model
        run: python BackEnds/the-snake-tank/train_model.py

      - name: Validate previous prediction
        run: |
          python BackEnds/the-snake-tank/validate_prediction.py \
            --prediction FrontEnds/the-fish-tank/data/prediction.json \
            --history FrontEnds/the-fish-tank/data/prediction-history.json \
            || true

      - name: Run temperature prediction
        run: python BackEnds/the-snake-tank/predict.py --output FrontEnds/the-fish-tank/data/prediction.json || true

      - name: Commit and push data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add BackEnds/the-snake-tank/data/ FrontEnds/the-fish-tank/data/prediction.json FrontEnds/the-fish-tank/data/prediction-history.json
          git diff --cached --quiet && echo "No new data to commit" && exit 0
          git commit -m "Add weather data $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push
